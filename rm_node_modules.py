import os
import sys
from os.path import join, isdir, realpath, exists
from shutil import rmtree

NODE_MODULES = "node_modules"
test = False

repoRoot = sys.argv[1]
rootPath = realpath(repoRoot)

if not exists(rootPath):
    print("'{0}' does not exist. Exiting.").format(rootPath)
    sys.exit(1)

if len(sys.argv) >= 3 and sys.argv[2] == "-t":
    test = True

print("Deleting '{0}' dirs in '{1}'").format(NODE_MODULES, rootPath)

for projectDir in os.listdir(rootPath):
    pdPath = realpath(join(rootPath, projectDir))

    if isdir(pdPath):
        for subDir in os.listdir(pdPath):
            sdPath = realpath(join(pdPath, subDir))

            if subDir == NODE_MODULES and isdir(sdPath):
                if test:
                    print("[TEST] Deleting {0}").format(sdPath)
                else:
                    print("Deleting {0}").format(sdPath)
                    rmtree(sdPath,ignore_errors=False)
